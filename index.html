<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem POS AFJ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --danger: #dc3545; --warning: #fbbc04; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; }
        
        .header-title { text-align: center; color: var(--primary); font-size: 1.4em; font-weight: bold; margin: 10px 0; text-transform: uppercase; }
        .copyleft { font-size: 0.45em; color: #666; font-weight: normal; margin-top: 2px; text-transform: none; display: block; }
        
        .panel { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        .btn-cam { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 10px 0; font-size: 16px; transition: 0.3s; }
        #btn-flash { width: 100%; padding: 12px; background: var(--warning); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px; display: none; }
        
        #status-msg { text-align: center; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; display: none; border: 2px solid transparent; min-height: 24px; }
        
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: var(--primary); outline: none; }

        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .qty-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .total-box { font-size: 2em; font-weight: bold; color: var(--primary); text-align: right; padding-top: 15px; border-top: 3px solid #eee; margin-top: 10px; }
        
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; margin-top: 10px; font-weight: bold; cursor: pointer; font-size: 15px; }
    </style>
</head>
<body>

<div class="header-title">
    ðŸ›’ SISTEM POS AFJ
    <span class="copyleft">copyleft by AK Jababeka</span>
</div>

<div class="panel">
    <div id="reader"></div>
    <button id="btn-scan-toggle" class="btn-cam" onclick="toggleScanner()">ðŸ“¸ BUKA SCANNER</button>
    <button id="btn-flash" onclick="toggleFlash()">ðŸ”¦ NYALAKAN LAMPU</button>
    
    <div id="status-msg"></div>
    
    <label style="font-size: 0.85em; font-weight: bold; color: #666;">Cari Nama Barang / Scan Barcode:</label>
    <input type="text" id="input-cari" placeholder="Ketik 'Aice' atau scan..." onkeyup="filterCepat()">
    
    <select id="select-produk" onchange="tambahViaPilihan()">
        <option value="">-- Memuat Data... --</option>
    </select>
</div>

<div class="panel">
    <h3>ðŸ“¦ Keranjang Belanja</h3>
    <div id="keranjang-list">
        <p style="text-align:center; color:#999;">Belum ada barang di keranjang.</p>
    </div>
    <div class="total-box">Rp <span id="total-harga">0</span></div>
    
    <button id="btn-wa" class="btn-action" onclick="kirimWhatsApp()" style="background:var(--success); color:white; display:none;">
        ðŸ’¬ KIRIM KE WHATSAPP
    </button>
    
    <button class="btn-action" onclick="resetCart()" style="background:var(--danger); color:white;">
        KOSONGKAN KERANJANG
    </button>
</div>

<script src="produk.js?v=1.0"></script>

<script>
let keranjang = [];
let html5QrCode; 
let track, flashOn = false, isScanning = false;

window.onload = () => {
    if (typeof daftarProduk !== 'undefined') {
        renderDropdown(daftarProduk);
    } else {
        document.getElementById('select-produk').innerHTML = '<option>Gagal memuat produk.js!</option>';
    }
};

function renderDropdown(list) {
    const sel = document.getElementById('select-produk');
    sel.innerHTML = '<option value="">-- Pilih Barang (A-Z) --</option>';
    const sorted = [...list].sort((a, b) => a.nama.localeCompare(b.nama));
    sorted.forEach(p => {
        let o = document.createElement('option');
        o.value = p.barcode;
        o.text = p.nama + " (Rp " + p.harga.toLocaleString() + ")";
        sel.appendChild(o);
    });
}

// FUNGSI TOGGLE SCANNER (PERBAIKAN)
function toggleScanner() {
    const btn = document.getElementById('btn-scan-toggle');
    const btnFlash = document.getElementById('btn-flash');

    // Cek apakah scanner sedang aktif (status 2 = SCANNING)
    if (html5QrCode && html5QrCode.getState() === 2) { 
        html5QrCode.stop().then(() => {
            btn.innerHTML = "ðŸ“¸ BUKA SCANNER";
            btn.style.background = "var(--primary)";
            btnFlash.style.display = 'none';
            btnFlash.innerText = "ðŸ”¦ NYALAKAN LAMPU";
            flashOn = false;
            track = null;
        }).catch(err => console.error("Gagal stop:", err));
    } else {
        jalankanKamera();
        btn.innerHTML = "ðŸ›‘ TUTUP SCANNER";
        btn.style.background = "var(--danger)";
    }
}

function jalankanKamera() {
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }
    
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 15, qrbox: 250 }, 
        (txt) => {
            if (!isScanning) {
                tambahBarang(txt);
                isScanning = true;
                setTimeout(() => { isScanning = false; }, 2000);
            }
        }
    ).then(() => {
        const video = document.querySelector('#reader video');
        if (video && video.srcObject) {
            track = video.srcObject.getVideoTracks()[0];
            const caps = track.getCapabilities();
            if (caps && caps.torch) {
                document.getElementById('btn-flash').style.display = 'block';
            }
        }
    }).catch(err => {
        console.error(err);
        document.getElementById('btn-scan-toggle').innerHTML = "ðŸ“¸ BUKA SCANNER";
        document.getElementById('btn-scan-toggle').style.background = "var(--primary)";
    });
}

function toggleFlash() {
    if (!track) return;
    flashOn = !flashOn;
    track.applyConstraints({ advanced: [{ torch: flashOn }] });
    document.getElementById('btn-flash').innerText = flashOn ? "ðŸ”¦ MATIKAN LAMPU" : "ðŸ”¦ NYALAKAN LAMPU";
}

function tambahBarang(kode) {
    const cleanKode = kode.trim();
    const msg = document.getElementById('status-msg');
    const inputCari = document.getElementById('input-cari');
    
    const matches = daftarProduk.filter(item => item.barcode == cleanKode);
    msg.style.display = "block";

    if (matches.length === 1) {
        eksekusiTambah(matches[0]);
        msg.innerText = "OK: " + matches[0].nama;
        msg.style.background = "#e6ffed"; msg.style.color = "#28a745"; msg.style.borderColor = "#28a745";
    } 
    else if (matches.length > 1) {
        msg.innerText = "DATA GANDA! PILIH MANUAL";
        msg.style.background = "#fff3cd"; msg.style.color = "#856404"; msg.style.borderColor = "#ffeeba";
        renderDropdown(matches);
        document.getElementById('select-produk').focus();
    } 
    else {
        msg.innerText = "BARCODE [" + cleanKode + "] TIDAK ADA";
        msg.style.background = "#fff0f0"; msg.style.color = "#dc3545"; msg.style.borderColor = "#f5c6cb";
        
        inputCari.focus();
        inputCari.placeholder = "Cari nama untuk barcode " + cleanKode;
        inputCari.style.border = "2px solid var(--danger)";
        setTimeout(() => { 
            inputCari.style.border = "1px solid #ddd"; 
            inputCari.placeholder = "Ketik 'Aice' atau scan...";
        }, 3000);
    }
    setTimeout(() => { msg.style.display = "none"; }, 3000);
}

function eksekusiTambah(produk) {
    const ada = keranjang.find(k => k.barcode === produk.barcode && k.nama === produk.nama);
    if(ada) { ada.qty += 1; } else { keranjang.unshift({...produk, qty: 1}); }
    updateDisplay();
}

function updateDisplay() {
    const list = document.getElementById('keranjang-list');
    const btnWA = document.getElementById('btn-wa');

    if(keranjang.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999;">Keranjang kosong.</p>';
        document.getElementById('total-harga').innerText = "0";
        btnWA.style.display = 'none';
        return;
    }

    btnWA.style.display = 'block';
    list.innerHTML = keranjang.map((k, i) => `
        <div class="cart-item">
            <div style="flex:1"><b>${k.nama}</b><br><small>Rp ${k.harga.toLocaleString()}</small></div>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="qty-btn" onclick="updateQty(${i},-1)">-</button>
                <b>${k.qty}</b>
                <button class="qty-btn" onclick="updateQty(${i},1)">+</button>
            </div>
            <div style="width:100px; text-align:right; font-weight:bold;">${(k.harga*k.qty).toLocaleString()}</div>
        </div>
    `).join('');
    
    const total = keranjang.reduce((s, k) => s + (k.harga * k.qty), 0);
    document.getElementById('total-harga').innerText = total.toLocaleString();
}

function kirimWhatsApp() {
    if (keranjang.length === 0) return;
    const noWA = "6283815898554"; // GANTI DENGAN NOMOR WA TUJUAN
    
    let pesan = `*STRUK PESANAN BELANJA - SISTEM POS AFJ*\n`;
    pesan += `------------------------------------------\n`;
    keranjang.forEach((item, index) => {
        pesan += `${index + 1}. *${item.nama}*\n`;
        pesan += `   ${item.qty} x Rp ${item.harga.toLocaleString()} = *Rp ${(item.qty * item.harga).toLocaleString()}*\n`;
    });
    const total = keranjang.reduce((s, k) => s + (k.harga * k.qty), 0);
    pesan += `------------------------------------------\n`;
    pesan += `*TOTAL: Rp ${total.toLocaleString()}*\n`;
    pesan += `------------------------------------------\n`;
    pesan += `Tgl: ${new Date().toLocaleString('id-ID')}`;

    window.open(`https://wa.me/${noWA}?text=${encodeURIComponent(pesan)}`, '_blank');
}

function filterCepat() {
    const kw = document.getElementById('input-cari').value.toLowerCase();
    const pPas = daftarProduk.find(d => d.barcode === kw);
    if(pPas) { 
        tambahBarang(kw); 
        document.getElementById('input-cari').value = "";
        return;
    }
    const filtered = daftarProduk.filter(d => 
        d.nama.toLowerCase().includes(kw) || d.barcode.includes(kw)
    );
    renderDropdown(filtered);
}

function tambahViaPilihan() {
    const v = document.getElementById('select-produk').value;
    if(v) { 
        tambahBarang(v); 
        document.getElementById('select-produk').value = "";
        document.getElementById('input-cari').value = "";
        renderDropdown(daftarProduk);
    }
}

function updateQty(i, d) {
    keranjang[i].qty += d;
    if(keranjang[i].qty <= 0) keranjang.splice(i, 1);
    updateDisplay();
}

function resetCart() { if(confirm("Kosongkan keranjang?")) { keranjang = []; updateDisplay(); } }
</script>
</body>
</html>
