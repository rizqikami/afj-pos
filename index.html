<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFJ POS System Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --danger: #dc3545; --warning: #fbbc04; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; }
        .header-title { text-align: center; color: var(--primary); font-size: 1.4em; font-weight: bold; margin: 10px 0; text-transform: uppercase; }
        .panel { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Scanner UI */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        .btn-cam { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 10px 0; font-size: 16px; }
        #btn-flash { width: 100%; padding: 12px; background: var(--warning); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px; display: none; }
        
        /* Notifikasi Stabil (Anti-Goyang) */
        #status-msg { text-align: center; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; display: none; border: 2px solid transparent; min-height: 24px; }
        
        /* Input & Dropdown */
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: var(--primary); outline: none; }

        /* Keranjang */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .qty-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .total-box { font-size: 2em; font-weight: bold; color: var(--primary); text-align: right; padding-top: 15px; border-top: 3px solid #eee; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header-title">ðŸ›’ AFJ POS SYSTEM</div>

<div class="panel">
    <div id="reader"></div>
    <button class="btn-cam" onclick="startScanner()">ðŸ“¸ BUKA SCANNER</button>
    <button id="btn-flash" onclick="toggleFlash()">ðŸ”¦ NYALAKAN LAMPU</button>
    
    <div id="status-msg"></div>
    
    <label style="font-size: 0.85em; font-weight: bold; color: #666;">Cari Nama Barang / Scan Barcode:</label>
    <input type="text" id="input-cari" placeholder="Ketik 'Aice' atau scan..." onkeyup="filterCepat()">
    
    <select id="select-produk" onchange="tambahViaPilihan()">
        <option value="">-- Memuat Data... --</option>
    </select>
</div>

<div class="panel">
    <h3>ðŸ“¦ Keranjang Belanja</h3>
    <div id="keranjang-list">
        <p style="text-align:center; color:#999;">Belum ada barang di keranjang.</p>
    </div>
    <div class="total-box">Rp <span id="total-harga">0</span></div>
    <button onclick="resetCart()" style="width:100%; padding:15px; background:var(--danger); color:white; border:none; border-radius:8px; margin-top:15px; font-weight:bold; cursor:pointer;">KOSONGKAN KERANJANG</button>
</div>

<script src="produk.js?v=1.0"></script>

<script>
let keranjang = [];
let scanner, track, flashOn = false, isScanning = false;

// Pastikan data produk terload
window.onload = () => {
    if (typeof daftarProduk !== 'undefined') {
        renderDropdown(daftarProduk);
    } else {
        document.getElementById('select-produk').innerHTML = '<option>Gagal memuat produk.js!</option>';
    }
};

function renderDropdown(list) {
    const sel = document.getElementById('select-produk');
    sel.innerHTML = '<option value="">-- Pilih Barang (A-Z) --</option>';
    const sorted = [...list].sort((a, b) => a.nama.localeCompare(b.nama));
    sorted.forEach(p => {
        let o = document.createElement('option');
        o.value = p.barcode;
        o.text = p.nama + " (Rp " + p.harga.toLocaleString() + ")";
        sel.appendChild(o);
    });
}

// SCANNER & FLASH LOGIC
function startScanner() {
    if (scanner) {
        scanner.stop().then(() => jalankanKamera()).catch(() => jalankanKamera());
    } else {
        jalankanKamera();
    }
}

function jalankanKamera() {
    scanner = new Html5Qrcode("reader");
    scanner.start(
        { facingMode: "environment" }, 
        { fps: 15, qrbox: 250 }, 
        (txt) => {
            if (!isScanning) {
                tambahBarang(txt);
                isScanning = true;
                setTimeout(() => { isScanning = false; }, 2000); // Delay 2 detik antar scan
            }
        }
    ).then(() => {
        const video = document.querySelector('#reader video');
        if (video && video.srcObject) {
            track = video.srcObject.getVideoTracks()[0];
            const caps = track.getCapabilities();
            if (caps.torch) document.getElementById('btn-flash').style.display = 'block';
        }
    }).catch(err => console.error("Scanner error:", err));
}

function toggleFlash() {
    if (!track) return;
    flashOn = !flashOn;
    track.applyConstraints({ advanced: [{ torch: flashOn }] });
    document.getElementById('btn-flash').innerText = flashOn ? "ðŸ”¦ MATIKAN LAMPU" : "ðŸ”¦ NYALAKAN LAMPU";
}

// LOGIKA INPUT BARANG
function tambahBarang(kode) {
    const cleanKode = kode.trim();
    const msg = document.getElementById('status-msg');
    
    const matches = daftarProduk.filter(item => item.barcode == cleanKode);
    msg.style.display = "block";

    if (matches.length === 1) {
        eksekusiTambah(matches[0]);
        msg.innerText = "OK: " + matches[0].nama;
        msg.style.background = "#e6ffed"; msg.style.color = "#28a745"; msg.style.borderColor = "#28a745";
    } 
    else if (matches.length > 1) {
        msg.innerText = "ADA " + matches.length + " DATA GANDA! PILIH MANA?";
        msg.style.background = "#fff3cd"; msg.style.color = "#856404"; msg.style.borderColor = "#ffeeba";
        renderDropdown(matches);
        document.getElementById('select-produk').focus();
    } 
    else {
        msg.innerText = "BARCODE [" + cleanKode + "] TIDAK TERDAFTAR";
        msg.style.background = "#fff0f0"; msg.style.color = "#dc3545"; msg.style.borderColor = "#f5c6cb";
        
        setTimeout(() => {
            const namaManual = prompt("Barang belum terdaftar. Masukkan Nama:");
            if (namaManual) {
                const hargaManual = prompt("Masukkan Harga:", "0");
                eksekusiTambah({
                    barcode: cleanKode,
                    nama: "[M] " + namaManual,
                    harga: parseInt(hargaManual) || 0
                });
            }
        }, 500);
    }
    setTimeout(() => { msg.style.display = "none"; }, 3000);
}

function eksekusiTambah(produk) {
    const ada = keranjang.find(k => k.barcode === produk.barcode && k.nama === produk.nama);
    if(ada) { ada.qty += 1; } else { keranjang.unshift({...produk, qty: 1}); }
    updateDisplay();
}

function updateDisplay() {
    const list = document.getElementById('keranjang-list');
    if(keranjang.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999;">Keranjang kosong.</p>';
        document.getElementById('total-harga').innerText = "0";
        return;
    }
    list.innerHTML = keranjang.map((k, i) => `
        <div class="cart-item">
            <div style="flex:1"><b>${k.nama}</b><br><small>Rp ${k.harga.toLocaleString()}</small></div>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="qty-btn" onclick="updateQty(${i},-1)">-</button>
                <b>${k.qty}</b>
                <button class="qty-btn" onclick="updateQty(${i},1)">+</button>
            </div>
            <div style="width:100px; text-align:right; font-weight:bold;">${(k.harga*k.qty).toLocaleString()}</div>
        </div>
    `).join('');
    const total = keranjang.reduce((s, k) => s + (k.harga * k.qty), 0);
    document.getElementById('total-harga').innerText = total.toLocaleString();
}

function filterCepat() {
    const kw = document.getElementById('input-cari').value.toLowerCase();
    const pPas = daftarProduk.find(d => d.barcode === kw);
    if(pPas) { 
        tambahBarang(kw); 
        document.getElementById('input-cari').value = "";
        return;
    }
    const filtered = daftarProduk.filter(d => 
        d.nama.toLowerCase().includes(kw) || d.barcode.includes(kw)
    );
    renderDropdown(filtered);
}

function tambahViaPilihan() {
    const v = document.getElementById('select-produk').value;
    if(v) { 
        tambahBarang(v); 
        document.getElementById('select-produk').value = "";
        document.getElementById('input-cari').value = "";
        renderDropdown(daftarProduk);
    }
}

function updateQty(i, d) {
    keranjang[i].qty += d;
    if(keranjang[i].qty <= 0) keranjang.splice(i, 1);
    updateDisplay();
}

function resetCart() { if(confirm("Kosongkan keranjang?")) { keranjang = []; updateDisplay(); } }
</script>

</body>
</html>
